pipeline {
    agent any
    
    // Poll GitHub every 2 minutes
    triggers {
        pollSCM('H/2 * * * *')
    }
    
    environment {
        DOCKER_IMAGE = 'nextjs-app'
        DOCKER_TAG = 'latest'
    }
    
    stages {
        stage('Code') {
            steps {
                echo 'This is Code Step'
                git url: 'https://github.com/asifkhan2513/puja.git',
                branch: 'main'
            }
        }
        
        stage('Build') {
            steps {
                echo 'This is Build Step'
                sh "docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} ."
            }
        }
        
        stage('Push To Dockerhub') {
            steps {
                echo 'This is Pushing Image to Dockerhub'
                script {
                    withCredentials([usernamePassword(
                        credentialsId: 'dockerHubCred',
                        passwordVariable: 'DOCKER_PASS',
                        usernameVariable: 'DOCKER_USER')]) {
                        
                        sh 'docker logout || true'
                        sh 'echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin'
                        sh "docker image tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_USER}/${DOCKER_IMAGE}:${DOCKER_TAG}"
                        
                        retry(3) {
                            timeout(time: 10, unit: 'MINUTES') {
                                sh "docker push ${DOCKER_USER}/${DOCKER_IMAGE}:${DOCKER_TAG}"
                            }
                        }
                        
                        echo "Image successfully pushed to Docker Hub"
                    }
                }
            }
        }
        
        stage('Deploy') {
            steps {
                echo 'This is Deploying Step'
            }
        }
    }
}